"use strict"

const path = require('path');
const fs = require('fs');

function resolve(packageName) {
  return path.dirname(require.resolve(packageName));
}

// Figure out where React and Flux are
let reactPath = resolve('react');;
reactPath = path.join(reactPath, 'dist', 'react.js');

let fluxPath = resolve('flux');
fluxPath = path.join(fluxPath, 'dist', 'Flux.js');

const moduleLoaderPublicPath = path.join(__dirname, 'dist');

const reactRelativePath = path.relative(moduleLoaderPublicPath, reactPath);
const fluxRelativePath = path.relative(moduleLoaderPublicPath, fluxPath);

const reactRelativeUrl = reactRelativePath.replace(/\\/g, '/');
const fluxRelativeUrl = fluxRelativePath.replace(/\\/g, '/');

function fixModuleLoaderBundle(distFile) {
  const moduleLoaderScriptPath = path.join(moduleLoaderPublicPath, distFile);
  let moduleLoaderScript = fs.readFileSync(moduleLoaderScriptPath, { encoding: 'utf-8' });
  moduleLoaderScript = moduleLoaderScript.replace('__RELATIVE_REACT_PATH__', reactRelativeUrl)
                                        .replace('__RELATIVE_FLUX_PATH__',  fluxRelativeUrl);
  fs.writeFileSync(moduleLoaderScriptPath, moduleLoaderScript);
}

fixModuleLoaderBundle('sp-module-loader.js');
fixModuleLoaderBundle('sp-module-loader_en-us.js');
